<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å‹•ç”»æ‰‹é †æ›¸ãƒ¢ãƒ¼ãƒ‰</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      height: 100%;
      overflow: hidden;
    }
    #video-container {
      width: 100vw;
      height: 100vh;
      display: none;
    }
    video {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: black;
    }
    #loading {
      color: white;
      text-align: center;
      margin-top: 30vh;
      font-size: 1.5rem;
    }
    #selectBtn {
      position: absolute;
      left: 1rem;
      background: #222;
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 8px;
      font-size: 2.5rem;
      z-index: 10;
      cursor: pointer;
      top: 1rem;
    }
    #selectBtn:hover {
      background: #444;
    }
  </style>
</head>
<body>
  <button id="selectBtn" onclick="location.href='/video_manual_selector'">ğŸ“– æ‰‹é †æ›¸ã‚’å†é¸æŠ</button>
  <div id="loading">å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</div>
  <div id="video-container">
    <video id="video" muted playsinline></video>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const title = params.get("title");

      let videoFiles = [];
      let currentIndex = 0;

      const video = document.getElementById("video");
      const loading = document.getElementById("loading");
      const container = document.getElementById("video-container");

      const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

      async function initialize() {
        try {
          const res = await fetch(`/get_manual?title=${encodeURIComponent(title)}`);
          const data = await res.json();

          if (!data.files || !Array.isArray(data.files) || data.files.length === 0) {
            throw new Error("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");
          }

          videoFiles = data.files;

          // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
          video.src = videoFiles[0];
          video.preload = "auto";
          video.load();

          await wait(300);  // å°‘ã—å¾…ã¤

          await new Promise((resolve, reject) => {
            const onLoaded = () => {
              video.removeEventListener("loadeddata", onLoaded);
              resolve();
            };
            const onError = () => {
              video.removeEventListener("error", onError);
              reject(new Error("å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—"));
            };
            video.addEventListener("loadeddata", onLoaded);
            video.addEventListener("error", onError);
          });

          await wait(300);  // èª­ã¿è¾¼ã¿å¾Œã‚‚å°‘ã—ä½™è£•

          loading.style.display = "none";
          container.style.display = "block";
          video.style.display = "block";

          await wait(300);  // è¡¨ç¤ºå¾Œã‚‚å°‘ã—ä½™è£•

          await video.play().catch(err => {
            console.warn("è‡ªå‹•å†ç”Ÿå¤±æ•—:", err);
            // å¿…è¦ãªã‚‰ã“ã“ã§æ‰‹å‹•å†ç”ŸUIã‚’å‡ºã™
          });
        } catch (err) {
          console.error(err);
          if (loading) loading.innerText = "å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        }
      }

      initialize();

      document.addEventListener("keydown", async (e) => {
        if (e.repeat || videoFiles.length === 0) return;

        if (e.code === "KeyC") {
          currentIndex = (currentIndex + 1) % videoFiles.length;
        } else if (e.code === "KeyA") {
          currentIndex = (currentIndex - 1 + videoFiles.length) % videoFiles.length;
        } else {
          return;
        }

        video.pause();
        video.src = videoFiles[currentIndex];
        video.load();
        await wait(200);

        await new Promise(resolve => {
          const onLoaded = () => {
            video.removeEventListener("loadeddata", onLoaded);
            resolve();
          };
          video.addEventListener("loadeddata", onLoaded);
        });

        await wait(200);
        video.play().catch(e => console.warn("åˆ‡æ›¿æ™‚å†ç”Ÿå¤±æ•—:", e));
      });
    });
  </script>
</body>
</html>
